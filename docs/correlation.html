<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title> 4 Correlations | RHUL Psychology Statistical modelling notebook</title>
<meta name="author" content="Matteo Lisi">
<meta name="description" content="Readers of this page will likely already familiar with the Pearson correlation coefficient and its significance test. The Pearson correlation coefficient measures the strength of association...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content=" 4 Correlations | RHUL Psychology Statistical modelling notebook">
<meta property="og:type" content="book">
<meta property="og:url" content="https://mlisi.xyz/RHUL-stats/correlation.html">
<meta property="og:image" content="https://mlisi.xyz/RHUL-stats/images/pop_brain.png">
<meta property="og:description" content="Readers of this page will likely already familiar with the Pearson correlation coefficient and its significance test. The Pearson correlation coefficient measures the strength of association...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" 4 Correlations | RHUL Psychology Statistical modelling notebook">
<meta name="twitter:description" content="Readers of this page will likely already familiar with the Pearson correlation coefficient and its significance test. The Pearson correlation coefficient measures the strength of association...">
<meta name="twitter:image" content="https://mlisi.xyz/RHUL-stats/images/pop_brain.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/clipboard-2.0.6/clipboard.min.js"></script><link href="libs/shareon-1.4.1/shareon.min.css" rel="stylesheet">
<script src="libs/shareon-1.4.1/shareon.min.js"></script><link href="libs/xaringanExtra-shareagain-0.2.6/shareagain.css" rel="stylesheet">
<script src="libs/xaringanExtra-shareagain-0.2.6/shareagain.js"></script><script src="libs/fitvids-2.1.1/fitvids.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">RHUL Psychology
Statistical modelling notebook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> About</a></li>
<li><a class="" href="surveys.html"><span class="header-section-number">2</span> Departmental survey about statistical methods</a></li>
<li><a class="" href="intro-R.html"><span class="header-section-number">3</span> Introduction to R</a></li>
<li><a class="active" href="correlation.html"><span class="header-section-number">4</span> Correlations</a></li>
<li><a class="" href="linear-models.html"><span class="header-section-number">5</span> Linear models</a></li>
<li><a class="" href="count-data.html"><span class="header-section-number">6</span> Models for count data</a></li>
<li><a class="" href="ordinal.html"><span class="header-section-number">7</span> Models for ordinal data</a></li>
<li><a class="" href="meta-analysis.html"><span class="header-section-number">8</span> Meta-analyses</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">9</span> Missing data</a></li>
<li><a class="" href="SDT.html"><span class="header-section-number">10</span> Signal Detection Theory</a></li>
<li><a class="" href="workshops.html"><span class="header-section-number">11</span> Workshops</a></li>
<li><a class="" href="useful-links-resources.html"><span class="header-section-number">12</span> Useful links &amp; resources</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/mattelisi/RHUL-stats">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="correlation" class="section level1" number="4">
<h1>
<span class="header-section-number"> 4</span> Correlations<a class="anchor" aria-label="anchor" href="#correlation"><i class="fas fa-link"></i></a>
</h1>
<p>Readers of this page will likely already familiar with the Pearson correlation coefficient and its significance test. The Pearson correlation coefficient measures the strength of association between two variables, denoted as <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, and is essentially a normalized measure of their covariance. It is calculated by dividing the covariance of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> by the product of their standard deviations:</p>
<p><span class="math display">\[
r_{x,y} = \frac{\text{cov}(x,y)}{\sigma_x \sigma_y}
\]</span></p>
<p>The normalization is achieved by dividing the covariance by the maximum possible covariance that can be attained when the variables are perfectly correlated, represented by the product of their standard deviations. This normalization constrains the Pearson correlation coefficient to a range between -1 and 1.</p>
<p>In R, simple correlation analyses can be run using the function <code>cor.test</code>.</p>
<p>In this chapter we will consider some more complex examples and issues that may occur when doing correlation analyses.</p>
<hr>
<div id="comparing-correlations" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Comparing correlations<a class="anchor" aria-label="anchor" href="#comparing-correlations"><i class="fas fa-link"></i></a>
</h2>
<p>Often, we have to compare a correlation value between two conditions (or groups or whatever). One simple approach to do this - if we have access to the raw data - is to run a regression model (with interaction term) with the condition as categorical predictor, and test whether the slope differs between the two conditions. (Note that if all the variables are standardized - i.e. transformed in Z-scores - the regression slope is identical to the Pearson correlation coefficient.)</p>
<p>If we don’t have the raw data available, we can still compare the correlations using <a href="https://en.wikipedia.org/wiki/Fisher_transformation">Fisher’s Z transform</a>. This requires first transforming all correlation values, e.g. <span class="math inline">\(r_1, r_2\)</span>, into Z scores using the following:</p>
<p><span class="math display">\[
Z=\frac{\log(1+r)−\log(1−r)}{2}
\]</span></p>
<p>We can then take the differences in these transformed correlation coefficients, and divide by <span class="math inline">\(\sqrt{\frac{1}{N_1 - 3} + \frac{1}{N_2 - 3}}\)</span>, where <span class="math inline">\(N_1\)</span> and <span class="math inline">\(N_2\)</span> are the sample size of the two conditions/groups that are compared. We obtain the statistics</p>
<p><span class="math display">\[
\Delta_Z = \frac{|Z_1 - Z_2|}{\sqrt{\frac{1}{N_1 - 3} + \frac{1}{N_2 - 3}}}
\]</span></p>
<p>Under the null hypothesis that the two correlations are not different (<span class="math inline">\(H_0: r_1 =r_2\)</span>) the statistics is normally distributed with mean 0 and variance 1, <span class="math inline">\(\Delta_Z \sim \mathcal{N}(0,1)\)</span>. Thus we can get a p value by using the cumulative distribution function of the normal distribution. For example, in R if the statistic is saved in the variable <code>Delta_Z</code> we can calculate the p-value using <code>p_value &lt;- 2*(1-pnorm(Delta_Z))</code>.</p>
<p>To verify the correctness of this approach, we can perform a simple simulation in R. The code below simulates multiple pairs of datasets, each consisting of two variables, from a population with a given correlation. In this simulation, the ‘true’ correlation value remains constant, representing the case where the null hypothesis is true. We then use the aforementioned approach to determine whether the difference is statistically significant. Finally, we calculate the proportion of significant tests (i.e., false positives) and verify that it is approximately equal to the desired false positive rate (alpha), conventionally set at 0.05.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to simulate correlated normal variables</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span><span class="op">=</span><span class="fl">100</span>, <span class="va">r</span><span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span><span class="va">N</span>, </span>
<span>               mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, </span>
<span>               Sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">r</span>,<span class="va">r</span>,<span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># function that calculate F transform and statistics</span></span>
<span><span class="va">Fisher_Z_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, <span class="va">N1</span>, <span class="va">N2</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">Z1</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">r1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">r1</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">Z2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">r2</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">r2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">denomin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">N1</span><span class="op">-</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">N2</span><span class="op">-</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">Delta_Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">Z1</span> <span class="op">-</span> <span class="va">Z2</span><span class="op">)</span><span class="op">/</span><span class="va">denomin</span></span>
<span>  <span class="va">p_value</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">Delta_Z</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>statistic<span class="op">=</span><span class="va">Delta_Z</span>, p<span class="op">=</span><span class="va">p_value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># run simulations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">N_sim</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span><span class="va">p_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">N_sim</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N_sim</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu">sim_data</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">d2</span> <span class="op">&lt;-</span> <span class="fu">sim_data</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">r1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">d1</span><span class="op">$</span><span class="va">X1</span>, <span class="va">d1</span><span class="op">$</span><span class="va">X2</span><span class="op">)</span></span>
<span>  <span class="va">r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">d2</span><span class="op">$</span><span class="va">X1</span>, <span class="va">d2</span><span class="op">$</span><span class="va">X2</span><span class="op">)</span></span>
<span>  <span class="va">test.results</span> <span class="op">&lt;-</span> <span class="fu">Fisher_Z_test</span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">p_vals</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">test.results</span><span class="op">$</span><span class="va">p</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># false positive rate</span></span>
<span><span class="co"># should be approximately equal to desired alpha</span></span>
<span><span class="co"># (here alpha=0.05)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p_vals</span><span class="op">&lt;</span><span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.0505</span></span></code></pre></div>
</div>
<div id="polychoric-and-polyserial-correlations" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Polychoric and polyserial correlations<a class="anchor" aria-label="anchor" href="#polychoric-and-polyserial-correlations"><i class="fas fa-link"></i></a>
</h2>
<p>Polychoric and polyserial correlations are methods used to estimate correlations between ordinal variables or between ordinal and continuous variables. These methods assume that the ordinal variables can be considered as divisions of underlying latent variables that follow a normal distribution (similar to ordinal models discussed in a later chapter). In R, calculating polychoric correlations is straightforward with the help of the <a href="https://cran.r-project.org/web/packages/polycor/index.html"><code>polycor</code> package</a>. You can use the <code>polychor</code> function to estimate correlations between two variables or the <code>hetcor</code> function to compute a correlation matrix for multiple variables simultaneously.</p>
</div>
<div id="partial-correlations" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Partial correlations<a class="anchor" aria-label="anchor" href="#partial-correlations"><i class="fas fa-link"></i></a>
</h2>
<p>Partial correlation is a statistical measure that quantifies the relationship between two variables while controlling for the effects of other variables. It assesses the strength and direction of the linear association between two variables after removing the influence of the remaining variables in the analysis.</p>
<p>Partial correlations are useful in situations where there are multiple variables that may be interconnected, and we want to understand the relationship between two variables while accounting for the effects of other variables. By calculating partial correlations, we can examine the direct association between two variables while holding constant the influence of other variables, thereby revealing the unique relationship between them.</p>
<p>Here are a few scenarios where partial correlations can be useful:</p>
<ul>
<li><p><strong>Confounding Control</strong>: In observational studies, there may be confounding variables that affect both the dependent and independent variables. By computing partial correlations, we can determine the relationship between the variables of interest while controlling for potential confounders.</p></li>
<li><p><strong>Multivariate Analysis</strong>: When examining the relationships between multiple variables simultaneously, partial correlations can help identify direct associations between pairs of variables, accounting for the shared influence of other variables in the analysis.</p></li>
<li><p><strong>Network Analysis</strong>: Partial correlations are commonly employed in network analysis to uncover the underlying structure and connections between variables, such as in gene regulatory networks, social networks, or financial networks.</p></li>
</ul>
<p>In R, and for simple Pearson’s correlation coefficients, we can use the packages <a href="https://cran.r-project.org/web/packages/ppcor/index.html"><code>ppcor</code></a> to calculate a matrix of partial correlation coefficients.</p>
<div id="partial-correlations-using-schur-complement" class="section level3" number="4.3.1">
<h3>
<span class="header-section-number">4.3.1</span> Partial correlations using Schur complement<a class="anchor" aria-label="anchor" href="#partial-correlations-using-schur-complement"><i class="fas fa-link"></i></a>
</h3>
<p>Occasionally, we may need to calculate partial polychoric correlations (e.g. partial correlations between ordinal variables). To the best of my knowledge there isn’t a simple package that allows to compute these. However, we can use an approach known as <a href="https://en.wikipedia.org/wiki/Schur_complement">Schur complement</a>.</p>
<p>The approach works as follow. Say we have computed a matrix of partial polychoric correlations using the <code>polycor</code> package; in particular <span class="math inline">\(\Sigma\)</span> is the correlation matrix between the variables of interests. We further have also a set of variables we want to account for (let’s call these ‘confounders’), and we calculate the matrix of the correlations between them, let’s call this <span class="math inline">\(C\)</span>. Finally, we also have a matrix of correlations between the variables of interest and the confounders, here notated as <span class="math inline">\(B\)</span>.</p>
<p>The partial correlation matrix can be computed as the Schur complement of <span class="math inline">\(C\)</span> in the block matrix <span class="math inline">\(M\)</span>, defined as <span class="math inline">\(M = \begin{bmatrix} \Sigma &amp; B \\ B^T &amp; C \end{bmatrix}\)</span>. Note that the matrix <span class="math inline">\(M\)</span> simply corresponds to the ‘full’ correlation matrix - the the matrix including correlations between <em>all</em> variables (variables of interest and confounders).</p>
<p>In practice, the Schur complement (partial correlation matrix) is computed as</p>
<p><span class="math display">\[\text{Partial Correlation Matrix} = \Sigma - BC^{-1}B^T.\]</span></p>
<p>Here is a simple function in R that can calculate the partial correlation matrix when some or all the variables are ordinal:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">partial_polychoric</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dX</span>, <span class="va">dC</span>, <span class="va">useML</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># dX is a dataframe containing variables of interest</span></span>
<span>  <span class="co"># dC is a dataframe containing confounding variables that needs to be partialled out</span></span>
<span>  <span class="co"># ML estimation is recommended, but may be slow with very large datasets</span></span>
<span>  <span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">dX</span>, <span class="va">dC</span><span class="op">)</span></span>
<span>  <span class="va">combined_polychoric_matrix</span> <span class="op">&lt;-</span> <span class="fu">hetcor</span><span class="op">(</span><span class="va">combined_data</span>, </span>
<span>                                       parallel<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                                       ML<span class="op">=</span><span class="va">useML</span>,</span>
<span>                                       use<span class="op">=</span><span class="st">"pairwise.complete.obs"</span><span class="op">)</span><span class="op">$</span><span class="va">correlations</span></span>
<span>  <span class="va">cor_dX</span> <span class="op">&lt;-</span> <span class="va">combined_polychoric_matrix</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">cor_dC</span> <span class="op">&lt;-</span> <span class="va">combined_polychoric_matrix</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">cor_yy</span> <span class="op">&lt;-</span> <span class="va">combined_polychoric_matrix</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span>, <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">combined_data</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">inv_cor_yy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">cor_yy</span><span class="op">)</span></span>
<span>  <span class="va">cor_dX</span> <span class="op">-</span> <span class="va">cor_dC</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">inv_cor_yy</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">cor_dC</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To estimate the p-values of partial correlation coefficients, we can use a permutation test: essentially we shuffle the order of columns in our dataset independently, then re-calculate the correlation matrix, and keep track of how often a correlation higher than the observed ones occur by chance.</p>
<p>The code below is an example of how such a test can be implemented in R</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># first, compute the observed matrix of partial correlation</span></span>
<span><span class="va">sigma_polychoric</span> <span class="op">&lt;-</span> <span class="fu">partial_polychoric</span><span class="op">(</span><span class="va">dX</span>, <span class="va">dC</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># custom function to shuffle independently the columns </span></span>
<span><span class="co"># of a data.frame containing ordinal variables</span></span>
<span><span class="va">shuffle_df</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">A_shuffle</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">A</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.ordered</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span><span class="va">x</span>, labels <span class="op">=</span> <span class="va">levels</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">A_shuffle</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Use replicate() to compute 1000 matrix from permutations of the datasets</span></span>
<span><span class="va">n_permutations</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">permuted_partial_polychoric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="va">n_permutations</span>, <span class="op">{</span></span>
<span>  <span class="va">permuted_dX</span> <span class="op">&lt;-</span> <span class="fu">shuffle_df</span><span class="op">(</span><span class="va">dX</span><span class="op">)</span></span>
<span>  <span class="va">permuted_dC</span> <span class="op">&lt;-</span> <span class="fu">shuffle_df</span><span class="op">(</span><span class="va">dC</span><span class="op">)</span></span>
<span>  <span class="fu">partial_polychoric</span><span class="op">(</span><span class="va">permuted_dX</span>, <span class="va">permuted_dC</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute p-values by counting how often we observe correlations </span></span>
<span><span class="co"># as high as that in the observed matrix from the permuted datasets.</span></span>
<span><span class="co"># The output is a mtrix of p-values</span></span>
<span><span class="va">p_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tot_it</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dX</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p_values</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">permuted_partial_polychoric</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span>, <span class="op">]</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">observed_partial_polychoric</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="intro-R.html"><span class="header-section-number">3</span> Introduction to R</a></div>
<div class="next"><a href="linear-models.html"><span class="header-section-number">5</span> Linear models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#correlation"><span class="header-section-number">4</span> Correlations</a></li>
<li><a class="nav-link" href="#comparing-correlations"><span class="header-section-number">4.1</span> Comparing correlations</a></li>
<li><a class="nav-link" href="#polychoric-and-polyserial-correlations"><span class="header-section-number">4.2</span> Polychoric and polyserial correlations</a></li>
<li>
<a class="nav-link" href="#partial-correlations"><span class="header-section-number">4.3</span> Partial correlations</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#partial-correlations-using-schur-complement"><span class="header-section-number">4.3.1</span> Partial correlations using Schur complement</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/mattelisi/RHUL-stats/blob/main/RHUL-stats-notebook/03-correlations.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/mattelisi/RHUL-stats/edit/main/RHUL-stats-notebook/03-correlations.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>RHUL Psychology
Statistical modelling notebook</strong>" was written by Matteo Lisi. It was last built on 2023-07-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
